<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pedidos Crisol</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      display: inline-block;
      width: 120px;
    }
    input, select {
      padding: 5px;
      margin: 5px 0;
    }
    button {
      padding: 10px 15px;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #f4f4f4;
    }
    .btn-cambiar-estado {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginContainer" style="text-align: center;">
  <h2>Ingresar al sistema</h2>
  <label for="loginLocal">Local:</label>
  <select id="loginLocal">
    <option value="">Selecciona un local</option>
    <option value="MOLINA">MOLINA</option>
    <option value="NOGUEIRA">NOGUEIRA</option>
    <option value="STA MARIA">STA MARIA</option>
    <option value="FABRICA">FABRICA</option>
  </select><br><br>

  <label for="loginPassword">Contraseña:</label>
  <input type="password" id="loginPassword" /><br><br>

  <button onclick="iniciarSesion()">Ingresar</button>
</div>

<!-- APP PRINCIPAL -->
<div id="appContainer" style="display:none;">
  <h2 style="text-align:center;">PEDIDOS - CRISOL</h2>
  <h3 id="nombreLocal" style="text-align:center; color:#555;"></h3>

  <form id="pedidoForm">
    <label for="fecha">Fecha:</label>
    <input type="date" id="fecha" required><br>

    <label for="local">Local:</label>
    <select id="local" required>
      <option value="MOLINA">MOLINA</option>
      <option value="NOGUEIRA">NOGUEIRA</option>
      <option value="STA MARIA">STA MARIA</option>
    </select><br>

    <label for="producto">Producto:</label>
    <input type="text" id="producto" required><br>

    <label for="cantidad">Cantidad:</label>
    <input type="number" id="cantidad" required><br>

    <button type="submit">Agregar Pedido</button>
  </form>

  <h3>Historial de Pedidos</h3>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Local</th>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Estado</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody id="historialPedidos"></tbody>
  </table>
</div>

<script>
  const contraseñasPorLocal = {
    "MOLINA": "1234",
    "NOGUEIRA": "2345",
    "STA MARIA": "3456",
    "FABRICA": "admin"
  };

  let localLogueado = null;
  let pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];

  function iniciarSesion() {
    const local = document.getElementById("loginLocal").value;
    const password = document.getElementById("loginPassword").value;

    if (!contraseñasPorLocal[local]) {
      alert("Selecciona un local válido.");
      return;
    }

    if (contraseñasPorLocal[local] === password) {
      localLogueado = local;

      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("appContainer").style.display = "block";
      document.getElementById("nombreLocal").textContent = `Local: ${localLogueado}`;

      const localSelect = document.getElementById("local");
      localSelect.value = localLogueado;
      localSelect.disabled = true;

      mostrarPedidos();
    } else {
      alert("Contraseña incorrecta.");
    }
  }

  document.getElementById("pedidoForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const pedido = {
      id: Date.now(),
      fecha: document.getElementById("fecha").value,
      local: document.getElementById("local").value,
      producto: document.getElementById("producto").value,
      cantidad: document.getElementById("cantidad").value,
      estado: "Pendiente"
    };

    pedidos.push(pedido);
    localStorage.setItem("pedidos", JSON.stringify(pedidos));

    this.reset();
    document.getElementById("local").value = localLogueado;

    mostrarPedidos();
  });

  function mostrarPedidos() {
    const tbody = document.getElementById("historialPedidos");
    tbody.innerHTML = "";

    let pedidosAMostrar = pedidos;

    if (localLogueado !== "FABRICA") {
      pedidosAMostrar = pedidos.filter(p => p.local === localLogueado);
    }

    pedidosAMostrar.forEach(pedido => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${pedido.fecha}</td>
        <td>${pedido.local}</td>
        <td>${pedido.producto}</td>
        <td>${pedido.cantidad}</td>
        <td>${pedido.estado}</td>
        <td>
          ${localLogueado === "FABRICA" ? `<button class="btn-cambiar-estado" data-id="${pedido.id}">Cambiar Estado</button>` : ""}
        </td>
      `;
      tbody.appendChild(row);
    });

    if (localLogueado === "FABRICA") {
      document.querySelectorAll(".btn-cambiar-estado").forEach(button => {
        button.addEventListener("click", function () {
          const id = Number(this.dataset.id);
          const pedido = pedidos.find(p => p.id === id);

          if (pedido) {
            if (pedido.estado === "Pendiente") {
              pedido.estado = "Producción";
            } else if (pedido.estado === "Producción") {
              pedido.estado = "Despachado";
            } else if (pedido.estado === "Despachado") {
              pedido.estado = "Pendiente";
            }

            localStorage.setItem("pedidos", JSON.stringify(pedidos));
            mostrarPedidos();
          }
   
  <!-- Librerías para PDF y Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>>
 <img src="Logo Crisol.png" alt="Logo Crisol" style="max-width: 120px; margin-bottom: 10px;" />
  </div>
  <h2>PEDIDOS - CRISOL</h2>

  <form id="pedidoForm">
    <label for="fecha">Fecha de retiro:</label>
    <input type="date" id="fecha" required />

    <label for="hora">Hora de retiro:</label>
    <input type="time" id="hora" required />
    </select>

    <label for="producto">Producto:</label>
    <select id="producto" required></select>

    <label for="dedicatoria">Dedicatoria:</label>
    <input type="text" id="dedicatoria" required />

    <label for="decoracion">Decoración:</label>
    <input type="text" id="decoracion" required />

    <label for="boleta">Número de boleta:</label>
    <input type="text" id="boleta" required />

    <label for="nombre">Nombre del cliente:</label>
    <input type="text" id="nombre" required />

    <label for="telefono">Teléfono del cliente:</label>
    <input type="tel" id="telefono" required pattern="[0-9]+" title="Solo números" />

    <label for="vendedor">Vendedor(a):</label>
    <input type="text" id="vendedor" required />

    <label for="observaciones">Observaciones:</label>
    <textarea id="observaciones" rows="3" placeholder="(Opcional)"></textarea>

    <button type="submit">Guardar Pedido</button>
  </form>

  <h3>Historial de Pedidos</h3>
  <div class="filtros">
    <input type="date" id="filtroFecha" />
    <input type="text" id="filtroLocal" placeholder="Filtrar por local" />
    <button onclick="exportarExcel()">Exportar Excel</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Local</th>
        <th>Producto</th>
        <th>Cliente</th>
        <th>Estado</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody id="tablaPedidos"></tbody>
  </table>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const productos = [
        { codigo: "2120", nombre: "3 LECHES 20P", precio: 18000 },
        { codigo: "2118", nombre: "AMAPOLA 20P", precio: 20000 },
        { codigo: "2010", nombre: "AMOR 20P", precio: 28000 },
        { codigo: "2008", nombre: "BISCOCHO PURE LUCUMA 20P", precio: 20000 },
        { codigo: "2015", nombre: "CHOCOLATE 20P", precio: 20000 },
        { codigo: "2017", nombre: "CHOCOLATE GUINDA ACIDA 20P", precio: 21000 },
        { codigo: "1046", nombre: "DISCO MERENGUE 20P", precio: 2000 },
        { codigo: "2016", nombre: "DURAZNO CHANTILLY 20P", precio: 20000 },
        { codigo: "2024", nombre: "FRAMBUESA NATURAL 0% AZUCAR 20P", precio: 21000 },
        { codigo: "2116", nombre: "FRAMBUESA NATURAL 20P", precio: 21000 },
        { codigo: "2006", nombre: "HELADA MERENGUE FRAMBUESA 20P", precio: 24000 },
        { codigo: "2066", nombre: "IMPERIAL BISCOCHO BLANCO 20P", precio: 21000 },
        { codigo: "2014", nombre: "MANJAR NUEZ 20P", precio: 21000 },
        { codigo: "2011", nombre: "MANJAR PLATANO 20P", precio: 18000 },
        { codigo: "2036", nombre: "MARGARITA 20P", precio: 26000 },
        { codigo: "2003", nombre: "MIL HOJAS 20P", precio: 26000 },
        { codigo: "2009", nombre: "MOKA 20P", precio: 18000 },
        { codigo: "1452", nombre: "MOROCHA 20P", precio: 18000 },
        { codigo: "2039", nombre: "MUSELINA 20P", precio: 18000 },
        { codigo: "2018", nombre: "PANQUEQUE CASTAÑA 20P", precio: 25000 },
        { codigo: "2005", nombre: "PANQUEQUE NARANJA 20P", precio: 24000 },
        { codigo: "2001", nombre: "PIÑA 20P", precio: 21000 },
        { codigo: "2044", nombre: "SACHER 20P", precio: 28000 },
        { codigo: "2002", nombre: "SELVA NEGRA 20P", precio: 25000 },
        { codigo: "2115", nombre: "TRUFA 20P", precio: 24000 },
        { codigo: "2035", nombre: "YOGURTH 20P", precio: 16000 }
      ];

      const selectProducto = document.getElementById("producto");
      productos.forEach(({nombre, precio}) => {
        const option = document.createElement("option");
        option.value = nombre;
        option.textContent = `${nombre} - $${precio.toLocaleString("es-CL")}`;
        selectProducto.appendChild(option);
      });
      const credencialesLocales = {
  "MOLINA": "clave1",
  "NOGUEIRA": "clave2",
  "STA MARIA": "clave3",
  "FABRICA": "admin123"
};

document.getElementById("login-form").addEventListener("submit", function(e) {
  e.preventDefault();

  const local = document.getElementById("local").value;
  const password = document.getElementById("password").value;

  if (credencialesLocales[local] === password) {
    localStorage.setItem("localLogueado", local);
    document.getElementById("login-section").style.display = "none";
    document.getElementById("app").style.display = "block";
    cargarPedidos(); // función que mostraría pedidos filtrados
  } else {
    alert("Contraseña incorrecta.");
  }
});


      // Mostrar pedidos con filtros
      function mostrarPedidos() {
        const tabla = document.getElementById("tablaPedidos");
        tabla.innerHTML = "";
        let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");

        // Aplicar filtros
        const filtroFecha = document.getElementById("filtroFecha").value;
        const filtroLocal = document.getElementById("filtroLocal").value.trim().toUpperCase();

        if (filtroFecha) {
          pedidos = pedidos.filter(p => p.fecha === filtroFecha);
        }
        if (filtroLocal) {
          pedidos = pedidos.filter(p => p.local.toUpperCase().includes(filtroLocal));
        }

        pedidos.forEach(pedido => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${pedido.id}</td>
            <td>${pedido.fecha}</td>
            <td>${pedido.hora}</td>
            <td>${pedido.local}</td>
            <td>${pedido.producto}</td>
            <td>${pedido.nombre}</td>
            <td>${pedido.estado}</td>
            <td>
  <button class="btn-cambiar-estado" data-id="${pedido.id}">Cambiar Estado</button>
  <button class="btn-descargar-pdf" data-id="${pedido.id}">PDF</button>
  <button class="btn-eliminar" data-id="${pedido.id}">Eliminar</button>
  <button onclick="cerrarSesion()">Cerrar sesión</button>

</td>

          `;
          tabla.appendChild(tr);
        });

        // Agregar evento a botones para cambiar estado
        document.querySelectorAll(".btn-cambiar-estado").forEach(btn => {
          btn.addEventListener("click", e => {
            const id = Number(e.target.dataset.id);
            cambiarEstado(id);
          });
        });
      }

      // Cambiar estado del pedido
      window.cambiarEstado = function(id) {
        let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
        const idx = pedidos.findIndex(p => p.id === id);
        if (idx === -1) return;
        const estados = ["Pendiente", "Producción", "Despachado"];
        let actual = pedidos[idx].estado;
        let siguienteIndex = (estados.indexOf(actual) + 1) % estados.length;
        pedidos[idx].estado = estados[siguienteIndex];
        localStorage.setItem("pedidos", JSON.stringify(pedidos));
        mostrarPedidos();
      };
function cerrarSesion() {
  localStorage.removeItem("localLogueado");
  location.reload();
} 

// Generar PDF con jsPDF
function generarPDF(pedido) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
  const fechaObj = new Date(pedido.fecha);
  const dia = fechaObj.getDate().toString().padStart(2,'0');
  const mes = meses[fechaObj.getMonth()];
  const año = fechaObj.getFullYear();
  const fechaFormateada = `${dia}-${mes}-${año}`;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(40);

  const margenIzquierdo = 10;
  const anchoMaximo = 180;

  const productoDividido = doc.splitTextToSize(`Producto: ${pedido.producto}`, anchoMaximo);
  const decoracionDividido = doc.splitTextToSize(`Decoración: ${pedido.decoracion}`, anchoMaximo);
  const observacionesDividido = doc.splitTextToSize(`Observación: ${pedido.observaciones || "Ninguna"}`, anchoMaximo);
  const nombreDividido = doc.splitTextToSize(`Nombre: ${pedido.nombre}`, anchoMaximo);

  doc.text(`${fechaFormateada} - ${pedido.hora}`, margenIzquierdo, 30);
  doc.text(`${pedido.local} - #${pedido.id}`, margenIzquierdo, 45);
  doc.text(productoDividido, margenIzquierdo, 65);
  doc.text(`Motivo: ${pedido.dedicatoria}`, margenIzquierdo, 120);
  doc.text(decoracionDividido, margenIzquierdo, 150);
  doc.text(nombreDividido, margenIzquierdo, 190);
  doc.text(`Teléfono: ${pedido.telefono}`, margenIzquierdo, 220);
  doc.text(`N° Boleta: ${pedido.boleta}`, margenIzquierdo, 235);
  doc.text(`Vendedor(a): ${pedido.vendedor}`, margenIzquierdo, 250);
  doc.text(observacionesDividido, margenIzquierdo, 265);

  const nombreArchivo = pedido.nombre.trim().replaceAll(" ", "_");
  doc.save(`${nombreArchivo}_pedido.pdf`);
}
// Exportar Excel con XLSX
  window.exportarExcel = function() {
    let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
    if(pedidos.length === 0){
      alert("No hay pedidos para exportar.");
      return;
    }
    const ws_data = [
      ["ID","Fecha","Hora","Local","Producto","Dedicatoria","Decoración","Boleta","Cliente","Teléfono","Vendedor","Observaciones","Estado"]
    ];
    pedidos.forEach(p => {
      ws_data.push([
        p.id, p.fecha, p.hora, p.local, p.producto, p.dedicatoria, p.decoracion,
        p.boleta, p.nombre, p.telefono, p.vendedor, p.observaciones || "", p.estado
      ]);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
    XLSX.writeFile(wb, "Pedidos_Crisol.xlsx");
  };

  // Guardar pedido
  document.getElementById("pedidoForm").addEventListener("submit", e => {
    e.preventDefault();
    let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");

    // Generar id incremental
    let maxId = pedidos.length > 0 ? Math.max(...pedidos.map(p => p.id)) : 0;
    const nuevoId = maxId + 1;

    const nuevoPedido = {
      id: nuevoId,
      fecha: document.getElementById("fecha").value,
      hora: document.getElementById("hora").value,
      local: document.getElementById("local").value,
      producto: document.getElementById("producto").value,
      dedicatoria: document.getElementById("dedicatoria").value,
      decoracion: document.getElementById("decoracion").value,
      boleta: document.getElementById("boleta").value,
      nombre: document.getElementById("nombre").value,
      telefono: document.getElementById("telefono").value,
      vendedor: document.getElementById("vendedor").value,
      observaciones: document.getElementById("observaciones").value,
      estado: "Pendiente"
    };

    pedidos.push(nuevoPedido);
    localStorage.setItem("pedidos", JSON.stringify(pedidos));

    generarPDF(nuevoPedido);

    // Limpiar formulario
    e.target.reset();

    mostrarPedidos();
  });

  // Actualizar listado al cambiar filtros
  document.getElementById("filtroFecha").addEventListener("change", mostrarPedidos);
  document.getElementById("filtroLocal").addEventListener("input", mostrarPedidos);

  mostrarPedidos();
      
});
    // Botón para descargar PDF por fila
document.querySelectorAll(".btn-descargar-pdf").forEach(btn => {
  btn.addEventListener("click", e => {
    const id = Number(e.target.dataset.id);
    const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
    const pedido = pedidos.find(p => p.id === id);
    if (pedido) generarPDF(pedido);
  });
});

// Botón para eliminar pedido
document.querySelectorAll(".btn-eliminar").forEach(btn => {
  btn.addEventListener("click", e => {
    const id = Number(e.target.dataset.id);
    if (confirm("¿Estás segura de que deseas eliminar este pedido?")) {
      let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
      pedidos = pedidos.filter(p => p.id !== id);
      localStorage.setItem("pedidos", JSON.stringify(pedidos));
      mostrarPedidos();
    }
  });
});

</script> </body> </html> ```

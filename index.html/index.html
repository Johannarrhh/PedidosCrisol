<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PEDIDOS - CRISOL</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fef6f2;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h2, h3 {
      text-align: center;
      color: #800000;
    }
    form {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      margin-top: 20px;
      padding: 10px;
      background-color: #800000;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #a52a2a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 13px;
    }
    th {
      background-color: #ffe5dc;
    }
    .filtros {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      justify-content: center;
    }
    .filtros input {
      max-width: 200px;
    }
  </style>

  <!-- Librerías para PDF y Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div style="text-align: center;">
    <img src="Logo Crisol.png" alt="Logo Crisol" style="max-width: 120px; margin-bottom: 10px;" />
  </div>
  <h2>PEDIDOS - CRISOL</h2>

  <form id="pedidoForm">
    <label for="fecha">Fecha de retiro:</label>
    <input type="date" id="fecha" required />

    <label for="hora">Hora de retiro:</label>
    <input type="time" id="hora" required />

    <label for="local">Local:</label>
    <select id="local" required>
      <option value="">Selecciona un local</option>
      <option value="MOLINA">MOLINA</option>
      <option value="NOGUEIRA">NOGUEIRA</option>
      <option value="STA MARIA">STA MARIA</option>
      <option value="FABRICA">FABRICA</option>
    </select>

    <label for="producto">Producto:</label>
    <select id="producto" required></select>

    <label for="dedicatoria">Dedicatoria:</label>
    <input type="text" id="dedicatoria" required />

    <label for="decoracion">Decoración:</label>
    <input type="text" id="decoracion" required />

    <label for="boleta">Número de boleta:</label>
    <input type="text" id="boleta" required />

    <label for="nombre">Nombre del cliente:</label>
    <input type="text" id="nombre" required />

    <label for="telefono">Teléfono del cliente:</label>
    <input type="tel" id="telefono" required pattern="[0-9]+" title="Solo números" />

    <label for="vendedor">Vendedor(a):</label>
    <input type="text" id="vendedor" required />

    <label for="observaciones">Observaciones:</label>
    <textarea id="observaciones" rows="3" placeholder="(Opcional)"></textarea>

    <button type="submit">Guardar Pedido</button>
  </form>

  <h3>Historial de Pedidos</h3>
  <div class="filtros">
    <input type="date" id="filtroFecha" />
    <input type="text" id="filtroLocal" placeholder="Filtrar por local" />
    <button onclick="exportarExcel()">Exportar Excel</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Local</th>
        <th>Producto</th>
        <th>Cliente</th>
        <th>Estado</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody id="tablaPedidos"></tbody>
  </table>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const productos = [
        { codigo: "2120", nombre: "3 LECHES 20P", precio: 18000 },
        { codigo: "2118", nombre: "AMAPOLA 20P", precio: 20000 },
        { codigo: "2010", nombre: "AMOR 20P", precio: 28000 },
        { codigo: "2008", nombre: "BISCOCHO PURE LUCUMA 20P", precio: 20000 },
        { codigo: "2015", nombre: "CHOCOLATE 20P", precio: 20000 },
        { codigo: "2017", nombre: "CHOCOLATE GUINDA ACIDA 20P", precio: 21000 },
        { codigo: "1046", nombre: "DISCO MERENGUE 20P", precio: 2000 },
        { codigo: "2016", nombre: "DURAZNO CHANTILLY 20P", precio: 20000 },
        { codigo: "2024", nombre: "FRAMBUESA NATURAL 0% AZUCAR 20P", precio: 21000 },
        { codigo: "2116", nombre: "FRAMBUESA NATURAL 20P", precio: 21000 },
        { codigo: "2006", nombre: "HELADA MERENGUE FRAMBUESA 20P", precio: 24000 },
        { codigo: "2066", nombre: "IMPERIAL BISCOCHO BLANCO 20P", precio: 21000 },
        { codigo: "2014", nombre: "MANJAR NUEZ 20P", precio: 21000 },
        { codigo: "2011", nombre: "MANJAR PLATANO 20P", precio: 18000 },
        { codigo: "2036", nombre: "MARGARITA 20P", precio: 26000 },
        { codigo: "2003", nombre: "MIL HOJAS 20P", precio: 26000 },
        { codigo: "2009", nombre: "MOKA 20P", precio: 18000 },
        { codigo: "1452", nombre: "MOROCHA 20P", precio: 18000 },
        { codigo: "2039", nombre: "MUSELINA 20P", precio: 18000 },
        { codigo: "2018", nombre: "PANQUEQUE CASTAÑA 20P", precio: 25000 },
        { codigo: "2005", nombre: "PANQUEQUE NARANJA 20P", precio: 24000 },
        { codigo: "2001", nombre: "PIÑA 20P", precio: 21000 },
        { codigo: "2044", nombre: "SACHER 20P", precio: 28000 },
        { codigo: "2002", nombre: "SELVA NEGRA 20P", precio: 25000 },
        { codigo: "2115", nombre: "TRUFA 20P", precio: 24000 },
        { codigo: "2035", nombre: "YOGURTH 20P", precio: 16000 }
      ];

      const selectProducto = document.getElementById("producto");
      productos.forEach(({nombre, precio}) => {
        const option = document.createElement("option");
        option.value = nombre;
        option.textContent = `${nombre} - $${precio.toLocaleString("es-CL")}`;
        selectProducto.appendChild(option);
      });

      // Función para mostrar pedidos en la tabla
      function mostrarPedidos() {
        const tabla = document.getElementById("tablaPedidos");
        tabla.innerHTML = "";
        let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");

        // Aplicar filtros
        const filtroFecha = document.getElementById("filtroFecha").value;
        const filtroLocal = document.getElementById("filtroLocal").value.trim().toUpperCase();

        if (filtroFecha) {
          pedidos = pedidos.filter(p => p.fecha === filtroFecha);
        }
        if (filtroLocal) {
          pedidos = pedidos.filter(p => p.local.toUpperCase().includes(filtroLocal));
        }

     pedidos.forEach(pedido => {
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>${pedido.id}</td>
    <td>${pedido.fecha}</td>
    <td>${pedido.hora}</td>
    <td>${pedido.local}</td>
    <td>${pedido.producto}</td>
    <td>${pedido.nombre}</td>
    <td>${pedido.estado}</td>
    <td><button class="btn-cambiar-estado" data-id="${pedido.id}">Cambiar Estado</button></td>
  `;

  tabla.appendChild(tr);
});

// Agregar event listeners a los botones
document.querySelectorAll(".btn-cambiar-estado").forEach(btn => {
  btn.addEventListener("click", e => {
    const id = Number(e.target.dataset.id);
    cambiarEstado(id);
  });
});
   // Cambiar estado del pedido
      window.cambiarEstado = function(id) {
        let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
        const idx = pedidos.findIndex(p => p.id === id);
        if (idx === -1) return;
        const estados = ["Pendiente", "Producción", "Despachado"];
        let actual = pedidos[idx].estado;
        let siguienteIndex = (estados.indexOf(actual) + 1) % estados.length;
        pedidos[idx].estado = estados[siguienteIndex];
        localStorage.setItem("pedidos", JSON.stringify(pedidos));
        mostrarPedidos();
      };

      // Generar PDF con jsPDF
      function generarPDF(pedido) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
        const fechaObj = new Date(pedido.fecha);
        const dia = fechaObj.getDate().toString().padStart(2,'0');
        const mes = meses[fechaObj.getMonth()];
        const año = fechaObj.getFullYear();
        const fechaFormateada = `${dia}-${mes}-${año}`;

            doc.setFontSize(16);
    doc.text("PEDIDO CRISOL", 105, 15, null, null, "center");
    doc.setFontSize(12);
    doc.text(`ID Pedido: ${pedido.id}`, 14, 30);
    doc.text(`Fecha Retiro: ${fechaFormateada}`, 14, 40);
    doc.text(`Hora Retiro: ${pedido.hora}`, 14, 50);
    doc.text(`Local: ${pedido.local}`, 14, 60);
    doc.text(`Producto: ${pedido.producto}`, 14, 70);
    doc.text(`Dedicatoria: ${pedido.dedicatoria}`, 14, 80);
    doc.text(`Decoración: ${pedido.decoracion}`, 14, 90);
    doc.text(`Boleta N°: ${pedido.boleta}`, 14, 100);
    doc.text(`Cliente: ${pedido.nombre}`, 14, 110);
    doc.text(`Teléfono: ${pedido.telefono}`, 14, 120);
    doc.text(`Vendedor(a): ${pedido.vendedor}`, 14, 130);
    doc.text(`Observaciones: ${pedido.observaciones || '-'}`, 14, 140);
    doc.text(`Estado: ${pedido.estado}`, 14, 150);

    doc.save(`Pedido_Crisol_${pedido.id}.pdf`);
  }

  // Guardar pedido desde el formulario
  const form = document.getElementById("pedidoForm");
  form.addEventListener("submit", e => {
    e.preventDefault();

    const nuevoPedido = {
      id: Date.now(),
      fecha: form.fecha.value,
      hora: form.hora.value,
      local: form.local.value,
      producto: form.producto.value,
      dedicatoria: form.dedicatoria.value.trim(),
      decoracion: form.decoracion.value.trim(),
      boleta: form.boleta.value.trim(),
      nombre: form.nombre.value.trim(),
      telefono: form.telefono.value.trim(),
      vendedor: form.vendedor.value.trim(),
      observaciones: form.observaciones.value.trim(),
      estado: "Pendiente"
    };

    // Guardar en localStorage
    let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
    pedidos.push(nuevoPedido);
    localStorage.setItem("pedidos", JSON.stringify(pedidos));

    generarPDF(nuevoPedido);

    form.reset();
    mostrarPedidos();
  });

  // Función para exportar a Excel usando SheetJS
  window.exportarExcel = function() {
    let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
    if (pedidos.length === 0) {
      alert("No hay pedidos para exportar.");
      return;
    }

    // Aplicar filtros antes de exportar
    const filtroFecha = document.getElementById("filtroFecha").value;
    const filtroLocal = document.getElementById("filtroLocal").value.trim().toUpperCase();

    if (filtroFecha) {
      pedidos = pedidos.filter(p => p.fecha === filtroFecha);
    }
    if (filtroLocal) {
      pedidos = pedidos.filter(p => p.local.toUpperCase().includes(filtroLocal));
    }

    const wb = XLSX.utils.book_new();
    const ws_data = [
      ["ID", "Fecha", "Hora", "Local", "Producto", "Dedicatoria", "Decoración", "Boleta", "Cliente", "Teléfono", "Vendedor", "Observaciones", "Estado"]
    ];
    pedidos.forEach(p => {
      ws_data.push([
        p.id, p.fecha, p.hora, p.local, p.producto, p.dedicatoria, p.decoracion, p.boleta,
        p.nombre, p.telefono, p.vendedor, p.observaciones || "", p.estado
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
    XLSX.writeFile(wb, "Pedidos_Crisol.xlsx");
  };

  // Eventos para filtros
  document.getElementById("filtroFecha").addEventListener("change", mostrarPedidos);
  document.getElementById("filtroLocal").addEventListener("input", mostrarPedidos);

  // Mostrar pedidos al cargar la página
  mostrarPedidos();
});
</script> </body> </html> ```
